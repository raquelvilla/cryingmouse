<!DOCTYPE html>
<html>
<head>
    <title>Dynamic, Multi-Set Crying Mouse Demo (Final)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS styles for the tears */
        body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff; /* Pure White Canvas */
            /* Prevents selection/dragging and default mobile scrolling */
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        
        /* INSTRUCTIONS OVERLAY */
        #instruction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Highest layer */
            transition: opacity 0.5s;
        }
        #instruction-overlay img {
            max-width: 90%;
            max-height: 90vh;
        }
        
        /* NEW COMBINED TEAR IMAGE CLASS: Removed the outer .tear div for performance */
        .tear-img { 
            position: absolute;
            pointer-events: none;
            height: auto; 
            width: auto;
            line-height: 1;
            display: block;
            transform: scale(1); 
            z-index: 1000; /* Tears are always on top */
            /* LONGER TRANSITION: 5.0 seconds for dramatic lingering and varied speed */
            transition: opacity 5.0s ease-out, top 5.0s ease-out, left 5.0s ease-out, transform 5.0s ease-out; 
        }
        
        /* Styles for the Slideshow Image (Collage element) */
        .collage-image {
            position: absolute; 
            max-width: 30%; 
            max-height: 50vh;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            z-index: 10; 
            opacity: 0; 
            /* Instant appearance; only smooth the transform (rotation/scale) */
            transition: transform 0.5s; 
            user-select: none; 
            pointer-events: none; 
        }
        #slideshow-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none; 
        }
    </style>
</head>
<body>
    
    <div id="slideshow-container"></div> 
    
    <div id="instruction-overlay">
        <img src="instruction.png" alt="Instructions">
    </div>

    <script>
        // --- STREAM VARIABLES ---
        let mouseX = 0;
        let mouseY = 0;
        let tearInterval = null;
        let startTime = 0; 
        let duration = 0; 
        let touchStarted = false; 
        
        // --- GLOBAL ELEMENTS ---
        const instructionOverlay = document.getElementById('instruction-overlay');

        // --- MULTIPLE TEAR SETS ---
        const tearImagesSetA = ['tear1.png', 'tear2.png', 'tear3.png']; 
        const tearImagesSetB = ['tear6.png', 'tear7.png', 'tear8.png']; 
        let activeTearSet = tearImagesSetA; 
        
        // --- SLIDESHOW VARIABLES ---
        const slideshowImages = [
            'slide1.jpg', 'slide2.jpg', 'slide3.jpg', 
            'slide4.jpg', 'slide5.jpg', 'slide6.png'
        ];
        let slideshowInterval = null;
        const slideDuration = 3000;
        let lastSlideTime = 0; 
        const slideshowContainer = document.getElementById('slideshow-container');
        let currentRAF = null; 

        // Function to hide the instructions
        function hideInstructions() {
            if (instructionOverlay.style.display !== 'none') {
                instructionOverlay.style.opacity = '0';
                setTimeout(() => {
                    instructionOverlay.style.display = 'none';
                }, 500); // Wait for fade-out transition (0.5s)
            }
        }

        // 1. Core Logic Functions
        function getDurationBasedHue() {
            if (startTime === 0) return 0;
            duration = (Date.now() - startTime) / 1000; 
            const hueShiftSpeed = 30;
            const hue = (duration * hueShiftSpeed) % 360; 
            return hue;
        }

        // Function to toggle the active tear set
        function toggleTearSet() {
            hideInstructions();
            if (activeTearSet === tearImagesSetA) {
                activeTearSet = tearImagesSetB;
                console.log('Switched to Tear Set B');
            } else {
                activeTearSet = tearImagesSetA;
                console.log('Switched to Tear Set A');
            }
        }

        function dropTear() {
            const currentHue = getDurationBasedHue();
            
            // --- SELECT IMAGE FROM ACTIVE SET ---
            const randomIndex = Math.floor(Math.random() * activeTearSet.length);
            const selectedImage = activeTearSet[randomIndex];
            
            // EXAGGERATED SIZE: Random size between 160px and 260px
            const randomSize = Math.floor(Math.random() * (260 - 160 + 1)) + 160; 
            const randomXOffset = Math.random() * 10 - 5; 
            
            // EXAGGERATED DYNAMICS: Random fall distance and horizontal drift
            const randomFallDistance = Math.random() * 160 + 40; 
            const randomDrift = Math.random() * 100 - 50;         

            // --- PERFORMANCE FIX: Create the Image element directly ---
            const tearImage = document.createElement('img');
            tearImage.className = 'tear-img'; // Use the new combined class
            tearImage.src = selectedImage; 
            tearImage.alt = 'Tear';
            tearImage.style.filter = `hue-rotate(${currentHue}deg)`; 
            
            const initialX = mouseX + randomXOffset; 
            const initialY = mouseY + 15; 

            tearImage.style.left = `${initialX}px`;
            tearImage.style.top = `${initialY}px`;
            tearImage.style.width = `${randomSize}px`; 
            
            document.body.appendChild(tearImage);

            // Animate (Fall, Fade, Shrink, and DRIFT)
            setTimeout(() => {
                tearImage.style.opacity = '0';
                tearImage.style.top = `${initialY + randomFallDistance}px`;
                tearImage.style.left = `${initialX + randomDrift}px`;
                
                tearImage.style.transform = 'scale(0.1)'; 
            }, 10); 

            // LONGER DURATION: Element removed after 5000ms (5.0 seconds)
            setTimeout(() => {
                tearImage.remove();
            }, 5000); 
        }
        
        // 2. Slideshow Logic (Collage)
        let imageCounter = 0; 
        
        function createCollageImage() {
            const imagePath = slideshowImages[imageCounter];
            imageCounter = (imageCounter + 1) % slideshowImages.length;

            const img = document.createElement('img');
            img.className = 'collage-image';
            img.src = imagePath;

            // --- Random Positioning (Angle is FIXED) ---
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            const randomX = Math.random() * (viewportWidth * 0.9);
            const randomY = Math.random() * (viewportHeight * 0.9);
            const randomScale = Math.random() * 0.4 + 0.6; 
            
            img.style.left = `${randomX}px`;
            img.style.top = `${randomY}px`;
            img.style.transform = `rotate(0deg) scale(${randomScale})`; 
            
            slideshowContainer.appendChild(img);
            
            // Image appears instantly
            img.style.opacity = '1';
        }
        
        // Continuous check function for reliable timing
        function checkCollageTime() {
            if (lastSlideTime > 0 && (Date.now() - lastSlideTime >= slideDuration)) {
                createCollageImage();
                lastSlideTime = Date.now(); // Reset the timer
            }
            // Keep checking only if the slideshow is active
            if (lastSlideTime > 0) {
                currentRAF = requestAnimationFrame(checkCollageTime);
            }
        }
        
        function startSlideshow() {
            hideInstructions(); // Hide instructions when slideshow starts
            if (lastSlideTime === 0) {
                lastSlideTime = Date.now(); // Start the timer
                createCollageImage(); // Create the first image immediately
                currentRAF = requestAnimationFrame(checkCollageTime); // Start the animation loop
            }
        }

        function stopSlideshow() {
            // Stop the continuous check
            if (currentRAF !== null) {
                cancelAnimationFrame(currentRAF);
                currentRAF = null;
            }
            lastSlideTime = 0; 
            
            // Clear all images when stopping the collage
            document.querySelectorAll('.collage-image').forEach(img => {
                img.style.opacity = '0';
                setTimeout(() => img.remove(), 1000);
            });
        }

        // 3. EVENT HANDLERS FOR CRYING (Touch and Mouse Down/Move)
        
        function startCrying(event) {
            hideInstructions(); // Hide instructions when crying starts
            
            // Mobile touch start logic
            if (event.touches) {
                touchStarted = true; 
                event.preventDefault(); 
                mouseX = event.touches[0].clientX;
                mouseY = event.touches[0].clientY;
            } 
            // Desktop mouse click logic
            else if (touchStarted) {
                return; // Ignore mouse clicks if a touch is active
            } else {
                mouseX = event.clientX;
                mouseY = event.clientY;
            }

            if (tearInterval === null) {
                startTime = Date.now(); 
                tearInterval = setInterval(dropTear, 3); 
                dropTear(); 
            }
        }

        function moveCrying(event) {
            // Mobile touch move logic
            if (event.touches) {
                event.preventDefault(); 
                
                if (tearInterval !== null) {
                    mouseX = event.touches[0].clientX;
                    mouseY = event.touches[0].clientY;
                }
            } 
            // Desktop mouse move logic
            else {
                if (touchStarted) {
                    return; // Ignore mouse moves if a touch is active
                }
                
                if (tearInterval !== null) {
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                }
            }
        }

        function stopCrying() {
            touchStarted = false; 

            if (tearInterval !== null) {
                clearInterval(tearInterval);
                tearInterval = null;
                startTime = 0; 
                duration = 0;
            }
        }
        
        // 4. ATTACHING THE EVENTS
        // Desktop mouse events
        document.addEventListener('mousedown', startCrying); 
        document.addEventListener('mouseup', stopCrying);   
        document.addEventListener('mousemove', moveCrying); 

        // Mobile touch events
        document.addEventListener('touchstart', startCrying); 
        document.addEventListener('touchend', stopCrying);     
        document.addEventListener('touchmove', moveCrying);  
        
        
        // 5. KEYDOWN/KEYUP LISTENERS (Spacebar, 'S', and 'T' key)
        document.addEventListener('keydown', function(event) {
            
            // 'S' key toggles the slideshow
            if (event.key === 's') {
                if (lastSlideTime === 0) {
                    startSlideshow();
                } else {
                    stopSlideshow();
                }
            }
            
            // 'T' key toggles the tear set
            else if (event.key === 't') {
                toggleTearSet();
            }

            // Spacebar Start (for desktop)
            else if (event.key === ' ' && tearInterval === null) {
                startCrying(event); // Use existing startCrying logic to hide instructions
            }
        });

        document.addEventListener('keyup', function(event) {
            // Spacebar Stop (for desktop)
            if (event.key === ' ' && tearInterval !== null) {
                clearInterval(tearInterval);
                tearInterval = null;
                startTime = 0; 
                duration = 0;
            }
        });
        
    </script>
</body>
</html>
